
## Коллекция products — Товары
### Shema: Product
```json

{
  "_id": "unique_product_id",
  "name": "Смартфон X",
  "category": "Электроника",
  "price": 15000,
  "stock_by_zone": {
    "moscow": 50,
    "ekaterinburg": 30
  },
  "attributes": {
    "color": "черный",
    "size": "medium"
  }
}
```
### Основные операции:
- Частые обновления остатков (на основе геозоны).
- Поиск по категории и цене.
- Получение полного описания товара.
### Шард-ключ: ```{ category: 1, price: 1 }```
Горизонтальное шардирование по категориям и цене
- Запросы часто фильтруют товары по категории и ценовому диапазону .
Э- то равномерно распределит данные по шардам, избегая горячих точек.
- Если бы мы использовали _id, это привело бы к неравномерному распределению при сканировании.
- Цена позволяет дополнительно разделить данные внутри категории.

### Индекс
```
products { category: 1, price: 1 }, { _id: 1 }
```

## Коллекция orders — Заказы:
### Shema: Order
```json
{
  "_id": "order_1",
  "user_id": "user_69",
  "created_at": ISODate("..."),
  "items": [
    { "product_id": "p1", "price": 15000 },
    { "product_id": "p2", "price": 800 }
  ],
  "status": "processing",
  "total_amount": 15800,
  "zone": "moscow"
}
```
### Основные операции:
- Быстрое создание заказов с одновременным списанием остатков.
- Поиск истории заказов конкретного пользователя.
- Отображение статуса заказа

### Шард-ключ: ```{ user_id: 1 }```
Шардирование по id пользователя
- Большинство запросов связаны с конкретным пользователем (история заказов).
- Группировка заказов одного пользователя в один шард упрощает чтение и оптимизирует производительность.

### Индекс
```
orders { user_id: 1, created_at: -1 }, { status: 1 }
```
## Коллекция carts — Корзины
### Shema: Сart
```json
{
  "_id": "cart_123",
  "user_id": "user_69",
  "session_id": "sess_789",
  "items": [
    { "product_id": "p1", "quantity": 2 }
  ],
  "status": "active", //active | ordered | abandoned
  "created_at": ISODate("..."),
  "updated_at": ISODate("..."),
  "expires_at": ISODate("...")
}
```
### Основные операции:
- Создание корзин (гостевых и пользовательских).
- Получение активной корзины.
- Обновление/удаление товаров.
- Слияние гостевой корзины в пользовательскую, если пользователь залогинится:
    прочитать гостевую { session_id, status:"active" };
    добавить её items в корзину { user_id, status:"active" };
    отметить гостевую как abandoned.
- Отметка корзины как заказанной.

### Шард-ключ: ```{ user_id: 1 }``` или ```{ session_id: 1 }```
 Шардирование по пользователю или сессии
- Для пользовательских корзин : шардировать по user_id — логично, так как большинство операций идет по пользователю.
- Для гостевых корзин : шардировать по session_id — аналогично, поскольку они ассоциированы с сессией.
- При слиянии можно временно использовать оба ключа.

### Индекс
```
carts { user_id: 1, status: 1 }, { session_id: 1, status: 1 }, { expires_at: 1 }
``` 
## Итого о шардировании коллекциях
|Коллекция|Шард-ключ|Тип|Комментарий|
|--|--|--|--|
|products|{ category: 1, price: 1 }|Горизонтальное шардирование|Подходит для фильтрации по категории и цене; равномерное распределение данных|
|orders|{ user_id: 1 }|Шардирование по пользователю|Позволяет быстро получать историю заказов конкретного пользователя|
|carts|{ user_id: 1 } <br>или<br> { session_id: 1 }|Шардирование по пользователю или сессии|Эффективно для работы с активными корзинами и их обновлениями| 

## Дополнительно: Масштабирование
Если потребуется масштабировать систему дальше, можно рассмотреть:
- Zone-based sharding для orders и products по геозонам.
- Time-based partitioning для старых заказов.